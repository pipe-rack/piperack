name: bump-and-tag

on:
  workflow_dispatch:
    inputs:
      part:
        description: "Version bump"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Bump Cargo.toml version
        id: bump
        shell: bash
        run: |
          PART="${{ inputs.part }}" python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          part = os.environ["PART"]
          path = Path("Cargo.toml")
          text = path.read_text()

          lines = text.splitlines()
          in_package = False
          version_line_index = None
          current = None

          for i, line in enumerate(lines):
              if line.strip().startswith("["):
                  in_package = line.strip() == "[package]"
                  continue
              if in_package:
                  m = re.match(r"(\s*version\s*=\s*\")([^\"]+)(\")", line)
                  if m:
                      version_line_index = i
                      current = m.group(2)
                      break

          if current is None:
              raise SystemExit("Could not find [package] version in Cargo.toml")

          parts = current.split(".")
          if len(parts) != 3 or not all(p.isdigit() for p in parts):
              raise SystemExit(f"Version '{current}' is not a simple semver X.Y.Z")

          major, minor, patch = map(int, parts)
          if part == "major":
              major += 1
              minor = 0
              patch = 0
          elif part == "minor":
              minor += 1
              patch = 0
          else:
              patch += 1

          new_version = f"{major}.{minor}.{patch}"

          m = re.match(r"(\s*version\s*=\s*\")([^\"]+)(\")", lines[version_line_index])
          lines[version_line_index] = f"{m.group(1)}{new_version}{m.group(3)}"

          path.write_text("\n".join(lines) + "\n")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"version={new_version}\n")
          PY
      - name: Commit version bump
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Cargo.toml
          git commit -m "Bump version to v${{ steps.bump.outputs.version }}"
      - name: Tag and push
        shell: bash
        run: |
          git tag "v${{ steps.bump.outputs.version }}"
          git push origin HEAD:main
          git push origin "v${{ steps.bump.outputs.version }}"
