name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  build:
    name: build-${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            os: macos-13
          - target: aarch64-apple-darwin
            os: macos-14
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-22.04
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-22.04
            use_cross: true

    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - if: matrix.use_cross
        name: Install cross
        run: cargo install cross --locked
      - name: Build
        shell: bash
        run: |
          if [ "${{ matrix.use_cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }}
          else
            cargo build --release --target ${{ matrix.target }}
          fi
      - name: Package
        shell: bash
        run: |
          version="${GITHUB_REF_NAME}"
          pkg="piperack-${version}-${{ matrix.target }}"
          mkdir -p dist
          tar -czf "dist/${pkg}.tar.gz" -C "target/${{ matrix.target }}/release" piperack
          if command -v shasum >/dev/null 2>&1; then
            shasum -a 256 "dist/${pkg}.tar.gz" | awk '{print $1}' > "dist/${pkg}.tar.gz.sha256"
          else
            sha256sum "dist/${pkg}.tar.gz" | awk '{print $1}' > "dist/${pkg}.tar.gz.sha256"
          fi
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.target }}
          path: dist/*

  publish:
    name: publish
    needs: build
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Prepare release assets
        shell: bash
        run: |
          mkdir -p release
          find dist -type f -maxdepth 2 -print0 | xargs -0 -I{} mv {} release/
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: release/*

  update-homebrew-tap:
    name: update-homebrew-tap
    needs: publish
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Read version
        id: version
        shell: bash
        run: |
          python3 - <<'PY'
          import os
          import re
          from pathlib import Path

          path = Path("Cargo.toml")
          text = path.read_text()

          in_package = False
          version = None
          for line in text.splitlines():
              if line.strip().startswith("["):
                  in_package = line.strip() == "[package]"
                  continue
              if in_package:
                  m = re.match(r"\s*version\s*=\s*\"([^\"]+)\"", line)
                  if m:
                      version = m.group(1)
                      break

          if not version:
              raise SystemExit("Could not find [package] version in Cargo.toml")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"version={version}\n")
          PY
      - name: Verify tag matches Cargo.toml
        shell: bash
        run: |
          if [ "v${{ steps.version.outputs.version }}" != "${GITHUB_REF_NAME}" ]; then
            echo "Tag ${GITHUB_REF_NAME} does not match Cargo.toml version ${{ steps.version.outputs.version }}" >&2
            exit 1
          fi
      - uses: actions/download-artifact@v4
        with:
          path: dist
      - uses: actions/checkout@v4
        with:
          repository: pipe-rack/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap
      - name: Update formula
        shell: bash
        run: |
          SHA_DIR="${GITHUB_WORKSPACE}/dist" \
          PIPERACK_DIR="${GITHUB_WORKSPACE}" \
          "${GITHUB_WORKSPACE}/homebrew-tap/scripts/update_formula.sh"
      - name: Commit and push
        shell: bash
        working-directory: homebrew-tap
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add Formula/piperack.rb
            git commit -m "Update piperack formula to v${{ steps.version.outputs.version }}"
            git push origin main
          else
            echo "No formula changes to commit."
          fi
